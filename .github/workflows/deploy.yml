# Deploy to Cloud Run (Backend) and Vercel (Frontend)
#
# Prerequisites:
# 1. Set up the following GitHub Secrets:
#    - GCP_PROJECT_ID: Your Google Cloud project ID
#    - GCP_SA_KEY: Service account key JSON (base64 encoded)
#    - VERCEL_TOKEN: Vercel API token
#    - VERCEL_ORG_ID: Vercel organization ID
#    - VERCEL_PROJECT_ID: Vercel project ID
#
# 2. Enable Cloud Run API in Google Cloud Console
# 3. Create a service account with Cloud Run Admin role
#
# Trigger: Push to main branch or manual dispatch

name: Deploy

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/workflows/ci.yml'
  workflow_dispatch:
    inputs:
      deploy_frontend:
        description: 'Deploy Frontend'
        required: true
        default: true
        type: boolean
      deploy_backend:
        description: 'Deploy Backend'
        required: true
        default: true
        type: boolean

env:
  REGION: asia-northeast1
  BACKEND_SERVICE: voice-transcription-api
  WORKER_SERVICE: voice-transcription-worker

jobs:
  # Build and test before deployment
  build-test:
    name: Build & Test
    runs-on: ubuntu-latest
    outputs:
      frontend_changed: ${{ steps.changes.outputs.frontend }}
      backend_changed: ${{ steps.changes.outputs.backend }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            frontend:
              - 'frontend/**'
            backend:
              - 'backend/**'

      - name: Setup Node.js
        if: steps.changes.outputs.frontend == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        if: steps.changes.outputs.frontend == 'true'
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        if: steps.changes.outputs.frontend == 'true'
        working-directory: frontend
        run: npm run build

      - name: Setup Python
        if: steps.changes.outputs.backend == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install backend dependencies
        if: steps.changes.outputs.backend == 'true'
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run backend syntax check
        if: steps.changes.outputs.backend == 'true'
        working-directory: backend
        run: python -m py_compile src/main.py src/config.py

  # Deploy Frontend to Vercel
  deploy-frontend:
    name: Deploy Frontend (Vercel)
    runs-on: ubuntu-latest
    needs: build-test
    if: |
      (github.event_name == 'push' && needs.build-test.outputs.frontend_changed == 'true') ||
      (github.event_name == 'workflow_dispatch' && inputs.deploy_frontend)
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Pull Vercel Environment
        working-directory: frontend
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build for Production
        working-directory: frontend
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel
        id: deploy
        working-directory: frontend
        run: |
          url=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=$url" >> $GITHUB_OUTPUT

      - name: Comment deployment URL
        uses: actions/github-script@v7
        if: github.event_name == 'push'
        with:
          script: |
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `ðŸš€ Frontend deployed to: ${{ steps.deploy.outputs.url }}`
            })

  # Deploy Backend to Cloud Run
  deploy-backend:
    name: Deploy Backend (Cloud Run)
    runs-on: ubuntu-latest
    needs: build-test
    if: |
      (github.event_name == 'push' && needs.build-test.outputs.backend_changed == 'true') ||
      (github.event_name == 'workflow_dispatch' && inputs.deploy_backend)
    environment:
      name: production
      url: https://${{ env.BACKEND_SERVICE }}-${{ secrets.GCP_PROJECT_ID }}.run.app
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker

      - name: Build Docker image
        working-directory: backend
        run: |
          docker build -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ env.BACKEND_SERVICE }}:${{ github.sha }} .
          docker tag gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ env.BACKEND_SERVICE }}:${{ github.sha }} gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ env.BACKEND_SERVICE }}:latest

      - name: Push Docker image
        run: |
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ env.BACKEND_SERVICE }}:${{ github.sha }}
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ env.BACKEND_SERVICE }}:latest

      - name: Deploy API to Cloud Run
        run: |
          gcloud run deploy ${{ env.BACKEND_SERVICE }} \
            --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ env.BACKEND_SERVICE }}:${{ github.sha }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --allow-unauthenticated \
            --memory 1Gi \
            --cpu 2 \
            --min-instances 0 \
            --max-instances 10 \
            --set-env-vars "ENVIRONMENT=production"

      - name: Deploy Celery Worker to Cloud Run
        run: |
          gcloud run deploy ${{ env.WORKER_SERVICE }} \
            --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ env.BACKEND_SERVICE }}:${{ github.sha }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --no-allow-unauthenticated \
            --memory 2Gi \
            --cpu 2 \
            --min-instances 0 \
            --max-instances 5 \
            --set-env-vars "ENVIRONMENT=production" \
            --command "celery" \
            --args "-A,src.celery_app,worker,--loglevel=warning,--concurrency=4"

      - name: Health Check
        run: |
          sleep 30
          curl -f https://${{ env.BACKEND_SERVICE }}-${{ secrets.GCP_PROJECT_ID }}.run.app/api/health/live || exit 1

  # Run database migrations
  migrate-database:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    needs: [build-test, deploy-backend]
    if: |
      (github.event_name == 'push' && needs.build-test.outputs.backend_changed == 'true') ||
      (github.event_name == 'workflow_dispatch' && inputs.deploy_backend)
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run migrations
        working-directory: backend
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: alembic upgrade head

  # Notify on completion
  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend, migrate-database]
    if: always()
    steps:
      - name: Notify success
        if: ${{ needs.deploy-frontend.result == 'success' || needs.deploy-backend.result == 'success' }}
        run: echo "Deployment completed successfully!"

      - name: Notify failure
        if: ${{ needs.deploy-frontend.result == 'failure' || needs.deploy-backend.result == 'failure' }}
        run: |
          echo "Deployment failed!"
          exit 1

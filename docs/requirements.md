# 音声・動画文字起こしツール - 要件定義書

## 要件定義の作成原則
- **「あったらいいな」は絶対に作らない**
- **拡張可能性のための余分な要素は一切追加しない**
- **将来の「もしかして」のための準備は禁止**
- **今、ここで必要な最小限の要素のみ**

---

## 1. プロジェクト概要

### 1.1 成果目標
動画・音声ファイル（長さ問わず）から高精度な日本語文字起こしを取得し、履歴管理しながら、ワンクリックでコピーして外部ツール（Google Docs等）でコンテンツ制作にすぐ活用できる状態を実現する。

### 1.2 成功指標

#### 定量的指標
1. **文字起こし精度**: 日本語で95%以上の認識精度
2. **処理速度**: 60分の音声を5分以内で文字起こし完了
3. **対応ファイル形式**: 主要5形式以上（mp3, mp4, wav, m4a, mov等）
4. **コピー操作**: 1クリックで全文コピー可能
5. **履歴管理**: 過去の文字起こし結果を無制限に保存・検索可能

#### 定性的指標
1. **シンプルさ**: ファイルをアップロードして待つだけで完了
2. **視認性**: 文字起こし結果が読みやすく、誤認識箇所を発見しやすい
3. **即座に活用可能**: コピーしたテキストがそのまま外部ツールで使える品質
4. **柔軟な出力**: プレーンテキスト、Markdown、字幕形式（SRT）など複数形式で出力可能
5. **履歴の使いやすさ**: 過去の文字起こしを日付・ファイル名で簡単に探せる

---

## 2. システム全体像

### 2.1 主要機能一覧
- **ファイルアップロード**: 動画・音声ファイルのドラッグ&ドロップ/選択アップロード
- **文字起こし処理**: OpenAI Whisper APIによる高精度な日本語文字起こし
- **結果表示・コピー**: 文字起こし結果の表示とワンクリックコピー
- **履歴管理**: 過去の文字起こし結果の保存・一覧表示・検索
- **出力形式変換**: プレーンテキスト、Markdown、SRT形式での出力

### 2.2 ユーザーロールと権限（MVP版）

**MVP版では認証機能を実装しない**
- 全機能が公開アクセス可能
- 履歴はlocalStorageで管理（ブラウザ内保存）
- 個人利用を想定

**Phase 11拡張時の予定**
- ユーザー登録・ログイン機能
- クラウド同期（複数デバイス対応）
- データベースでの永続化

### 2.3 認証・認可要件

**MVP版**: 認証なし
- 認証方式: なし
- セキュリティレベル: 公開アクセス
- 管理機能: 不要

---

## 3. ページ詳細仕様

### 3.1 P-001: 文字起こしメインページ

#### 目的
ファイルアップロードから文字起こし結果表示まで一画面で完結し、即座にテキストをコピーして活用できる

#### 主要機能
- ファイルドラッグ&ドロップ/選択アップロード
- アップロード進捗表示（プログレスバー）
  - パーセンテージ表示（0-100%）
  - ステータステキスト表示
  - アップロード速度表示（MB/s）
  - 推定残り時間表示
- 文字起こし処理状況表示（処理中/完了）
- 文字起こし結果の表示（読みやすいフォーマット）
- ワンクリックコピー機能
  - Clipboard API使用
  - コピー成功時スナックバー表示
  - アイコン変更（2秒間チェックマーク表示）
- 出力形式選択（プレーンテキスト/Markdown/SRT）
- エラー表示・再試行機能
  - エラーメッセージ表示（赤色、アイコン付き）
  - 「再試行」ボタン表示
  - 「キャンセル」ボタン表示
  - 最大3回まで自動リトライ（ネットワークエラーのみ）
  - リトライ間隔: 2秒、5秒、10秒（指数バックオフ）

#### 必要な操作

| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 作成 | ファイルアップロード | 音声・動画ファイル（mp3, mp4, wav, m4a, mov等） | アップロード完了通知、ファイルURL |
| 作成 | 文字起こし実行 | ファイルURL | 文字起こしテキスト、タイムスタンプ |
| 取得 | 文字起こし結果表示 | 文字起こしID | 文字起こしテキスト |
| 取得 | 出力形式変換 | 文字起こしテキスト、形式（text/markdown/srt） | 指定形式のテキスト |

#### 処理フロー
1. ユーザーがファイルをドラッグ&ドロップ、または選択
2. フロントエンドがファイルをバックエンドへ送信
3. バックエンドがCloudflare R2へファイル保存
4. Celery Workerがバックグラウンドで文字起こし処理を開始
5. Whisper APIで文字起こし実行
6. 結果をデータベースに保存
7. フロントエンドがポーリングで結果を取得
8. 文字起こし結果を画面に表示
9. ユーザーがワンクリックでコピー
10. localStorageに履歴を保存

#### データ構造（概念）

```yaml
TranscriptionJob:
  識別子: UUID（一意のID）
  基本情報:
    - original_filename（必須）: 元のファイル名
    - file_url（必須）: Cloudflare R2のファイルURL
    - file_size（必須）: ファイルサイズ（bytes）
    - duration（任意）: 音声の長さ（秒）
    - language（必須）: 言語コード（デフォルト: "ja"）
  文字起こし情報:
    - transcription_text（任意）: 文字起こし結果テキスト
    - status（必須）: 処理状態（processing/completed/failed）
    - error_message（任意）: エラーメッセージ
  メタ情報:
    - created_at: 作成日時
    - updated_at: 更新日時
    - completed_at: 完了日時
  関連:
    - なし（MVP版は単体データ）
```

---

### 3.2 P-002: 履歴一覧ページ

#### 目的
過去の文字起こし結果を管理し、再利用を容易にする

#### 主要機能
- 文字起こし履歴の一覧表示（カード形式）
- 検索機能（ファイル名、テキスト内容）
  - 部分一致検索（大文字小文字区別なし）
  - リアルタイム検索（入力中に即座に絞り込み）
  - 空白区切りで複数キーワード対応（AND検索）
  - ハイライト表示（検索ワードを黄色背景でマーク）
- 日付フィルタリング（今日、今週、今月、全期間）
- ソート機能（日付昇順/降順）
- 詳細表示（クリックでモーダル表示）
- ワンクリックコピー機能
- 削除機能
- localStorage容量管理
  - 容量80%超過時: 警告表示
  - 容量95%超過時: 古い履歴10件を自動削除
  - 削除基準: created_at（作成日時）が最も古いもの

#### 必要な操作

| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | 履歴一覧取得 | 検索キーワード（任意）、日付フィルタ（任意） | 文字起こし履歴の配列 |
| 取得 | 詳細表示 | 文字起こしID | 文字起こし詳細情報 |
| 削除 | 履歴削除 | 文字起こしID | 削除完了通知 |

#### 処理フロー
1. ページ読み込み時にlocalStorageから履歴を取得
2. 履歴をカード形式で一覧表示
3. ユーザーが検索ワードを入力すると、リアルタイムフィルタリング
4. 日付フィルタを選択すると、該当期間の履歴のみ表示
5. カードをクリックすると、モーダルで詳細表示
6. コピーボタンで文字起こしテキストをクリップボードへコピー
7. 削除ボタンでlocalStorageから削除

#### データ構造（概念）

```yaml
TranscriptionHistory:
  識別子: UUID
  基本情報:
    - original_filename（必須）
    - transcription_text（必須）
    - created_at（必須）
  表示用情報:
    - preview_text（任意）: テキストの最初の100文字（プレビュー用）
    - file_size（任意）
    - duration（任意）
  関連:
    - TranscriptionJob（元の文字起こしジョブ）
```

---

## 4. データ設計概要

### 4.1 主要エンティティ

```yaml
TranscriptionJob:
  概要: 文字起こしジョブを表現
  主要属性:
    - ID（UUID）
    - ファイル情報（original_filename, file_url, file_size, duration）
    - 文字起こし情報（transcription_text, language, status, error_message）
    - タイムスタンプ（created_at, updated_at, completed_at）
  関連:
    - なし（MVP版は単体テーブル）
```

### 4.2 エンティティ関係図

```
TranscriptionJob（単体テーブル）
  - MVP版は他テーブルとの関連なし
  - Phase 11拡張時にUserテーブルと1対多の関連追加
```

### 4.3 バリデーションルール

```yaml
original_filename:
  - ルール: 1文字以上、255文字以内
  - 理由: ファイル名の識別とデータベース制約

file_size:
  - ルール: 最大2GB（2,147,483,648 bytes）
  - 理由: Whisper APIの25MB制限に対応（ffmpegで圧縮）

duration:
  - ルール: 0秒以上
  - 理由: 音声の長さを記録

transcription_text:
  - ルール: 制限なし（TEXT型）
  - 理由: 長時間音声の文字起こしに対応

status:
  - ルール: processing / completed / failed のいずれか
  - 理由: 処理状態の管理
```

---

## 5. 制約事項

### 外部API制限
- **OpenAI Whisper API**:
  - 25MBファイル制限 → ffmpegで自動圧縮対応
  - Rate Limit: 分単位の制限あり（通常利用で問題なし）
- **Cloudflare R2**:
  - 10GB無料枠（初期テスト用）
  - 100万回操作/月無料

### 技術的制約
- **ファイルサイズ**: 最大2GB（実用上の制限）
- **処理時間**: 60分の音声で約4-5分（Whisper APIの処理速度）
- **localStorageサイズ**: 約5-10MB（ブラウザ依存）
  - 1件あたりの推定サイズ: 約50-100KB
  - 保存可能件数: 約50-100件
  - 容量超過対応: 古い履歴の自動削除

---

## 5.1 セキュリティ要件

### 基本方針
本プロジェクトは **CVSS 3.1（Common Vulnerability Scoring System）** に準拠したセキュリティ要件を満たすこと。

CVSS 3.1の評価観点:
- **機密性（Confidentiality）**: 不正アクセス防止、データ暗号化
- **完全性（Integrity）**: データ改ざん防止、入力検証
- **可用性（Availability）**: DoS対策、冗長化

詳細な診断と改善は、Phase 11（本番運用診断）で @本番運用診断オーケストレーター が実施します。

---

### プロジェクト固有の必須要件

**MVP版（認証なし）の必須要件**:
- ✅ HTTPSの強制（本番環境）
- ✅ セキュリティヘッダー設定（本番環境）
- ✅ 入力値のサニタイゼーション（ファイル名、検索ワード）
- ✅ ファイルタイプ検証（mp3, mp4, wav, m4a, mov, webm, mpeg のみ）
- ✅ ファイルサイズ制限（2GB）
- ✅ エラーメッセージでの情報漏洩防止

**Phase 11拡張時（認証あり）の追加要件**:
- ✅ ブルートフォース攻撃対策（アカウントロックアウト）
- ✅ パスワードポリシー（8文字以上、複雑性要件）
- ✅ セッション管理（タイムアウト、CSRF対策）

---

### 運用要件：可用性とヘルスチェック

**ヘルスチェックエンドポイント（全プロジェクト必須）**:
- エンドポイント: `/api/health`
- 目的: Cloud Run/Kubernetesでのliveness/readinessプローブ
- 要件: データベース接続確認、5秒以内の応答

**グレースフルシャットダウン（全プロジェクト必須）**:
- SIGTERMシグナルハンドラーの実装
- 進行中のリクエスト完了まで待機
- タイムアウト: 8秒（Cloud Runの10秒制限に対応）

---

## 6. 複合API処理（バックエンド内部処理）

### 複合処理-001: ファイルアップロード→文字起こし実行

**トリガー**: 「ファイルをアップロード」ボタンクリック

**フロントエンドAPI**: POST /api/transcriptions/upload

**バックエンド内部処理**:
1. ファイルバリデーション（形式、サイズ）
2. ファイルサイズチェック：25MB超の場合はffmpegで圧縮
3. Cloudflare R2へファイル保存
4. データベースにTranscriptionJobレコード作成（status: processing）
5. Celeryタスクをキューに追加（非同期処理）
6. Celery Worker内でWhisper API呼び出し
7. 文字起こし結果をデータベースに保存（status: completed）
8. エラー時は status: failed に更新

**結果**: TranscriptionJob ID、処理状態

**外部サービス依存**: Cloudflare R2, OpenAI Whisper API, Redis, PostgreSQL

---

### 複合処理-002: 文字起こし状況ポーリング

**トリガー**: フロントエンドが5秒ごとにポーリング

**フロントエンドAPI**: GET /api/transcriptions/{job_id}/status

**バックエンド内部処理**:
1. データベースからTranscriptionJob取得
2. status, transcription_text を返却

**結果**: 処理状態、文字起こし結果（完了時）

**外部サービス依存**: PostgreSQL

---

## 7. 技術スタック

### フロントエンド
- **フレームワーク**: React 18
- **言語**: TypeScript 5
- **UIライブラリ**: MUI v6（Material-UI）
- **状態管理**: Zustand
- **ルーティング**: React Router v6
- **データフェッチ**: React Query
- **ビルドツール**: Vite 5

### バックエンド
- **言語**: Python 3.11+
- **フレームワーク**: FastAPI
- **非同期処理**: Celery
- **タスクキュー**: Redis
- **ファイル処理**: ffmpeg
- **ORM**: SQLAlchemy
- **マイグレーション**: Alembic

### データベース
- **メインDB**: PostgreSQL（Neon）
  - サーバーレスで管理不要
  - 無料枠512MB
  - 自動スケーリング

### ストレージ
- **初期**: Cloudflare R2（10GB無料、S3互換API）
- **本番移行後**: AWS S3（必要に応じて）

### インフラ
- **フロントエンド**: Vercel
- **バックエンド**: Google Cloud Run
- **キャッシュ/タスクキュー**: Redis Cloud（30MB無料枠）

---

## 8. 必要な外部サービス・アカウント

### 必須サービス

| サービス名 | 用途 | 取得先 | 備考 |
|-----------|------|--------|------|
| **OpenAI API** | 音声・動画の文字起こし（Whisper API） | https://platform.openai.com | 新規$5クレジット付与（約14時間分） |
| **Cloudflare R2** | ファイルストレージ（初期テスト用） | https://dash.cloudflare.com | 10GB無料、S3互換API |
| **Neon** | PostgreSQLデータベース | https://neon.tech | 512MB無料枠 |
| **Vercel** | フロントエンドホスティング | https://vercel.com | GitHub連携、無制限デプロイ |
| **Google Cloud** | バックエンドホスティング（Cloud Run） | https://cloud.google.com | 無料枠: 月200万リクエスト |
| **Redis Cloud** | タスクキュー（Celeryブローカー） | https://redis.com/try-free | 30MB無料枠 |

### オプションサービス（本番移行後）

| サービス名 | 用途 | 取得先 | 備考 |
|-----------|------|--------|------|
| **AWS S3** | ファイルストレージ（本番用） | https://aws.amazon.com | Cloudflare R2から移行時 |
| **CloudFront** | CDN（配信高速化） | https://aws.amazon.com | S3導入時に検討 |
| **Sentry** | エラー監視 | https://sentry.io | 無料枠: 5,000エラー/月 |

---

## 9. 今後の拡張予定

**原則**: 拡張予定があっても、必要最小限の実装のみを行う

- 「あったらいいな」は実装しない
- 拡張可能性のための余分な要素は追加しない
- 将来の「もしかして」のための準備は禁止
- 今、ここで必要な最小限の要素のみを実装

拡張が必要になった時点で、Phase 11: 機能拡張オーケストレーターを使用して追加実装を行います。

### Phase 11拡張候補（実装はしない）

1. **ユーザー認証機能**
   - ユーザー登録・ログイン
   - クラウド同期（複数デバイス対応）
   - データベースでの永続化

2. **リアルタイム文字起こし**
   - 録音しながら文字起こし
   - Google/Azure APIへの切り替え

3. **話者識別機能**
   - 複数話者の自動判別
   - Pyannote等の外部ツール併用

4. **AI要約機能**
   - 文字起こしテキストの自動要約
   - OpenAI GPT APIとの連携

5. **多言語対応**
   - 日本語以外の言語の文字起こし
   - 言語自動判別

---

## 10. UX詳細仕様

### 10.1 ファイルドラッグ&ドロップUI
```yaml
ドロップエリア:
  - 画面中央に大きく表示
  - 破線の枠線（ドラッグ中に色変更）
  - アイコン + テキスト表示

状態別UI:
  - 通常時: グレー破線、「ファイルをドラッグ&ドロップ」
  - ドラッグ中: 青色破線、「ここにドロップ」
  - エラー時: 赤色破線、エラーメッセージ
```

### 10.2 プログレスバー詳細
```yaml
表示タイミング: ファイル選択直後にアップロード開始

表示内容:
  - パーセンテージ表示（0-100%）
  - 現在のステータステキスト（「アップロード中...」「処理中...」）
  - アップロード速度表示（MB/s）
  - 推定残り時間

デザイン:
  - MUI LinearProgress コンポーネント
  - アニメーション付き（スムーズな進行）
```

### 10.3 エラーメッセージ一覧
```yaml
ネットワークエラー:
  - メッセージ: 「接続に失敗しました。再試行してください。」
  - 再試行: 自動3回 + 手動ボタン

ファイルサイズ超過:
  - メッセージ: 「ファイルサイズが2GBを超えています。」
  - 再試行: 不可

非対応形式:
  - メッセージ: 「対応していないファイル形式です。mp3, mp4, wav, m4a, movをご利用ください。」
  - 再試行: 不可
```

### 10.4 コピー機能詳細
```yaml
実装方法:
  - Clipboard API使用（navigator.clipboard.writeText()）
  - コピー成功時にスナックバー表示（「コピーしました」）

コピーボタン:
  - MUI IconButton（ContentCopyアイコン）
  - ツールチップ表示（「コピー」）
  - クリック後にアイコン変更（CheckCircleアイコン、2秒間）
```

### 10.5 検索機能詳細
```yaml
検索対象:
  - original_filename（ファイル名）
  - transcription_text（文字起こしテキスト）

検索方式:
  - 部分一致検索（大文字小文字区別なし）
  - リアルタイム検索（入力中に即座に絞り込み）
  - 空白区切りで複数キーワード対応（AND検索）

検索UI:
  - 検索ボックス（MUI TextField）
  - 検索アイコン表示
  - クリアボタン（×）表示

ハイライト表示:
  - 検索ワードに一致する箇所を黄色背景でハイライト
  - HTMLの<mark>タグを使用
  - 表示箇所: ファイル名、文字起こしテキストのプレビュー（最初の100文字）
```

### 10.6 localStorage容量管理
```yaml
容量制限:
  - ブラウザのlocalStorage制限: 約5-10MB
  - 1件あたりの推定サイズ: 約50-100KB
  - 保存可能件数: 約50-100件

容量超過時の対応:
  1. 容量チェック（保存前）
  2. 容量が80%を超えた場合、警告表示
  3. 容量が95%を超えた場合、古い履歴を自動削除

自動削除ロジック:
  - 削除基準: created_at（作成日時）が最も古いもの
  - 削除単位: 最古の10件を削除
  - 削除時に通知表示

警告メッセージ:
  - 80%超過: 「履歴の保存容量が残り少なくなっています。不要な履歴を削除してください。」
  - 95%超過: 「保存容量が不足しています。古い履歴10件を自動削除しました。」
```

---

**要件定義書作成日**: 2025-12-10
**最終更新日**: 2025-12-10
